. ./envrc

sflags="-D_FORTIFY_SOURCE=2 -fstack-protector-strong -Werror=format-security"

cat << EOF
pd = $PD
cflags = $CFLAGS -Wall -Wextra -std=c++2b -fpic -shared
rule cc
  command = gcc -MD -MF \$out.d \$cflags -I $ID -I $INSTALL_DIR/include -I $INSTALL_DIR/include/snort -o \$out \$in
  deps = gcc
  depfile = \$out.d

rule lk
  command = g++ \$in -shared -O0 -Wall -g -Wextra -o \$out
EOF

final="build tm.so: lk "

for m in $(cat plugins.list); do
	printf "build $m.o: cc "
	cat "$PD/$m/files.list" | sed s#^#$PD/$m/# | tr '\n' ' '
	printf "\n"
	final="$final $m.o"
done

echo $final